name: Build and Run

# 触发条件：支持标签推送、main分支推送和手动触发
on:
  push:
    tags:
      - 'v*'  # 匹配v1.0.0等标签
    branches:
      - main  # 当main分支有推送时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Generate version.txt
      run: |
        # 根据触发类型设置版本号
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          # 如果是标签触发，使用标签名作为版本（如v1.0.0）
          echo "${{ github.ref_name }}" > version.txt
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          # 如果是main分支触发，使用开发版本标识
          echo "dev-${{ github.sha::8 }}" > version.txt
        else
          # 其他情况使用默认版本
          echo "1.0.0" > version.txt
        fi
      shell: bash

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Run
      run: ${{github.workspace}}/build/hello
      shell: bash
